<project name="Revo-testoj" basedir="/home/revo/voko/tst">
    <description>
       Reta Vortaro, testoj.
    </description>

  <!-- set global properties for this build -->
  <property name="voko" location="/home/revo/voko"/>
  <property name="ant" location="${voko}/ant"/>
  <property name="revo" location=".test"/>
  <property name="testoj" location="${revo}/testoj"/>
  <property name="inx" location="${revo}/inx"/>
  <property name="xml" location="${revo}/xml"/>
  <property name="xsl" location="${voko}/xsl"/>
  <property name="tmp" location="${revo}/.tmp"/>

  <target name="init">

   <!-- kreu vortareton por testo -->
   <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="forigu" inheritAll="false"/>

    <mkdir dir="${revo}" />
    <mkdir dir="${xml}" />
 
    <echo 
file="${xml}/test.xml"><![CDATA[<?xml version="1.0"?>
<vortaro>
<art mrk="\$$Id: test.xml asdfosdf">
  <kap><rad>test</rad>/o <var><kap><tld/>oo</kap></var></kap>
  <drv mrk="test.0o">
    <kap><tld/>o</kap>
    <mlg>T</mlg>
    <snc mrk="test.0o.GEOL">
      <uzo tip="fak">GEOL</uzo>
      <dif>fusx (<trd lng="de"><ind>Test</ind> in Definition</trd>) fusx fusx:
        <ekz><ind>testo malbona chio malbona</ind> 
             <trd lng="de">Test schlecht alles schlecht</trd></ekz>;
        <ekz><ind>unu <mll tip="mez">malbona testo</mll> chion
      malbonigas</ind>
            <trd lng="de">ein <mll tip="mez">schlechter <ind>Test</ind></mll>
      verdirbt alles</trd></ekz>.
      </dif>
      <trd lng="de">Test <klr>(GEO)</klr></trd>
    </snc>
    <snc mrk="test.0o.XXX">
      <dif>balbut balbut balbut</dif>
    </snc>
    <bld src="test.jpg"><ind>bildigita testo</ind> :-)<trd lng="de"><ind>Test</ind>bild</trd></bld>
    <trd lng="de">Test</trd>
    <trd lng="en">test</trd>
  </drv>
  <drv mrk="test.0i">
    <kap><tld/>i <var><kap><tld/>oi</kap></var></kap>
    <dif>strang strang strang</dif>
    <trdgrp lng="de">
      <trd>testen</trd>,
      <trd>probieren</trd>
      <trd>aus<ind>probieren</ind></trd>
      <trd>klrtest1 <klr>(ne en la indekso)</klr></trd>
      <trd>klrtest2 <klr tip="ind">(en la indekso)</klr></trd>
      <trd>klrtest3 <klr tip="amb">(en la indekso kaj la artikolo)</klr></trd>
    </trdgrp>
    <trd lng="en">to test</trd>
  </drv>
  <drv mrk="test.bona0o">
     <kap>bona <tld/>o</kap>
  </drv>
</art>
</vortaro>
]]>
    </echo>

    <echo 
file="${xml}/de.xml"><![CDATA[<?xml version="1.0"?>
<vortaro>
<art mrk="\$Id: de.xml asdfosdf">
  <kap><rad>de</rad></kap>
  <drv mrk="de.0">
    <kap><tld/></kap>
    <trdgrp lng="de">
      <trd>Aorta</trd>
      <trd>Apfel</trd>
      <trd>apfel</trd>
      <trd>&#x00c4;pfel</trd>
      <trd>&#x00e4;pfel</trd>
      <trd>Arie</trd>
      <trd>Muse</trd>
      <trd>Mu&#x00df;e</trd>
      <trd>Mut</trd>
    </trdgrp>
    <trdgrp lng="br">
      <trd>cab</trd>
      <trd>chb</trd>
      <trd>c'hb</trd>
    </trdgrp>
    <trdgrp lng="cy">
      <trd>cab</trd>
      <trd>chb</trd>
      <trd>ala</trd>
      <trd>alla</trd>
      <trd>alma</trd>
    </trdgrp>
    <trd lng="la">de</trd>
  </drv>
</art>
</vortaro>
]]>
    </echo>
</target>


<target name="test-init" depends="init"
  description="preparas la testilojn">

    <mkdir dir="${testoj}" />

    <echo 
file="${testoj}/testshablono.tmp"><![CDATA[<?xml version="1.0"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                 version="1.0">

   <xsl:output method="text" encoding="utf-8"/>

   <xsl:template match="/">
   @tests@
   </xsl:template>

   <xsl:template name="testo">
         <xsl:param name="priskribo"/>
         <xsl:param name="testo"/>
    
         <xsl:value-of select="normalize-space($priskribo)"/><xsl:text>: </xsl:text>
         <xsl:choose>
           <xsl:when test="$testo"><xsl:text>bone
</xsl:text></xsl:when>
           <xsl:otherwise><xsl:text>ERARO!
</xsl:text></xsl:otherwise>
         </xsl:choose>

   </xsl:template>
</xsl:stylesheet>
]]>
   </echo>

   <echo 
file="${testoj}/preparu-teston.xsl"><![CDATA[<?xml version="1.0"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                 version="1.0">

   <xsl:output method="text" encoding="utf-8"/>

   <xsl:template match="//t">
     &lt;xsl:call-template name="testo"&gt;
       &lt;xsl:with-param name="priskribo"&gt;
        &lt;xsl:text&gt;<xsl:value-of select="."/>&lt;/xsl:text&gt;
      &lt;/xsl:with-param&gt;
      &lt;xsl:with-param name="testo"&gt;
        &lt;xsl:value-of select="<xsl:value-of select="@test"/>"/&gt;
      &lt;/xsl:with-param&gt;
    &lt;/xsl:call-template&gt;
  </xsl:template> 

</xsl:stylesheet>
]]>
    </echo>
</target>

  <target name="faru-teston">
    <xslt style="${testoj}/preparu-teston.xsl"
        in="${testoj}/${testnomo}.xml" out="${testoj}/${testnomo}.tst"/>

    <loadfile srcFile="${testoj}/${testnomo}.tst" property="tests"/>
    <filter token="tests" value="${tests}"/>
    <copy file="${testoj}/testshablono.tmp" tofile="${testoj}/${testnomo}.xsl" 
       filtering="true"/>

    <xslt style="${testoj}/${testnomo}.xsl"
        in="${testajho}" out="${testoj}/${testnomo}.rez"/>
  </target>



  <target name="indeks-testo" depends="init,test-init"
    description="testas la regulojn en indekso.xml">

    <!-- testu eltiradon de la indeksinformoj -->

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="eltiro" inheritAll="false"/>



    <!-- testu kategoriadon de la indeksinformoj -->

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="kategorioj" inheritAll="false"/>   

    <echo 
file="${testoj}/indeks-testo-kat.xml"><![CDATA[<?xml version="1.0"?>
<testoj>
     <t test="count(//kap-oj/v[@mrk='test' and k='testo' and
     k1='test/o' and r='tset'])=1">
   1) Chu kapvorto "test/o", inversigita radiko "tset", mrk "test" enestas</t>

     <t test="count(//kap-oj/v[@mrk='test.0o'])=0">
   2) Chu kapvorto kun mrk "test.0o" ne enestas</t>

     <t test="count(//kap-oj/v[@mrk='test.0i' and k='testi'])=1">
   3) Chu kapvorto "testi" mrk "test.0i" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0o' and
     k='testo' and t='Test'])=1">
   4) Chu germana traduko "Test" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='testen'])=1">
   5) Chu germana traduko "testen" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='probieren'])=2">
   6) Chu germanaj tradukoj "probieren" kaj "ausprobieren" enestas</t>

     <t test="count(//trd-oj[@lng='en']/v[@mrk='test.0i' and
     k='testi' and t='to test'])=1">
   7) Chu angla traduko "to test" enestas</t>

     <t test="count(//fako[@fak='GEOL']/v[@mrk='test.0o.GEOL' and
     .='testo'])=1">   
   8) Chu fakindiko GEOL che kapvorto "testo" enestas</t>
 
     <t test="count(//mlg-oj/v[@mrk='test.0o' and
     t='T' and k='testo'])=1">   
   9) Chu mallongigo T che kapvorto "testo" enestas</t>
 
     <t test="count(//bld-oj/v[@mrk='test.0o' and
     t='bildigita testo :-)' and k='testo'])=1">   
   10) Chu bildo pri kapvorto "testo" enestas</t>
 
     <t test="count(//trd-oj[@lng='ja'])=0">   
   11) Chu japanaj tradukoj ne enestas</t>

      <t test="count(//fako[@fak='MAT'])=0">   
   12) Chu fako MAT ne enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='probieren' and t1/u='probieren' and t1/text()='aus'])=1">
   13) Chu germana traduko "aus_probieren_" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0o.GEOL' and
     k='testo malbona chio malbona' and t='Test schlecht alles schlecht'])=1">
   14) Chu germana traduko "Test schlecht alles schlecht" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0o.GEOL' and
     k='...malbona testo...' and t='Test' and t1/u='Test' and
   contains(t1,'...schlechter ')])=1">
   15) Chu germana traduko "...schlechter Test..." enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='klrtest1 '])=1">
   16) Chu germana traduko "klrtest1" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='klrtest2 ' and t1='klrtest2 (en la indekso)'])=1">
   17) Chu germana traduko "klrtest2 (en la indekso)" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='klrtest3 ' and t1='klrtest3 (en la indekso kaj la artikolo)'])=1">
   18) Chu germana traduko "klrtest3 (en la indekso kaj la artikolo)" enestas</t>

   <t test="count(//kap-oj/v[@mrk='test' and k='testoo'])=1">
   19) Chu variajho "testoo" mrk "test" enestas</t>

   <t test="count(//kap-oj/v[@mrk='test.0i' and k='testoi'])=1">
   20) Chu variajho "testoi" mrk "test.0i" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0o.GEOL' and
     k='testo' and t='Test' and t1/u='Test' and t1/text()=' in Definition'])=1">
   21) Chu endifina germana traduko "_Test_ in Definition" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0o' and
     k='bildigita testo' and t='Test' and t1/u='Test' and
   contains(t1,'bild')])=1">
   22) Chu germana traduko "Testbild" enestas</t>

    <t test="count(//kap-oj/v[@mrk='test.bona0o' and k='bona testo'])=1">
   23) Chu kapvorto "bona testo" mrk "test.bona0o" enestas kaj kun spacsigno</t>

</testoj>
]]>
    </echo>

    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-kat"/>
       <param name="testajho" value="${tmp}/inx_kat.xml"/>
    </antcall>

    <loadfile property="rezulto_1" srcFile="${testoj}/indeks-testo-kat.rez"/>
    <echo>test-rezultoj pri dosiero inx_kat.xml:
${rezulto_1}   
    </echo>

   <!-- testu ordigadon de la indeksinformoj -->


    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="ordigo" inheritAll="false"/>

    <echo 
file="${testoj}/indeks-testo-ord.xml"><![CDATA[<?xml version="1.0"?>
<testoj>
     <t test="count(//kap-oj/litero[@name='t']/v[@mrk='test' and k='testo'])=1">
   1) Chu kapvorto "testo" estas sub litero "t"</t>

     <t test="count(//inv/litero[@name='t']/v[@mrk='test' and k='test/o'])=1">
   2) Chu kapvorto "testo" estas sub inv/litero "t"</t>

     <t test="count(//kap-oj/litero[@name='t']/v[@mrk='test.0i' and k='testi'])=1">
   3) Chu kapvorto "testi" estas sub litero "t"</t>

     <t test="count(//trd-oj[@lng='de']/litero[@name='t']/v[@mrk='test.0o' and
     k='testo' and t='Test'])=1">
   4) Chu germana traduko "Test" estas sub litero "t"</t>

     <t test="count(//trd-oj[@lng='de']/litero[@name='t']/v[@mrk='test.0i' and
     k='testi' and t='testen'])=1">
   5) Chu germana traduko "testen" estas sub litero "t"</t>

     <t test="count(//trd-oj[@lng='de']/litero[@name='p']/v[@mrk='test.0i' and
     k='testi' and t='probieren'])=2">
   6) Chu germanaj tradukoj "ausprobieren" kaj "probieren" estas sub litero "p"</t>

     <t test="count(//trd-oj[@lng='en']/litero[@name='t']/v[@mrk='test.0i' and
     k='testi' and t='to test'])=1">
   7) Chu angla traduko "to test" estas sub litero "t"</t>

     <t test="count(//fako[@fak='GEOL']/v[@mrk='test.0o.GEOL' and
     .='testo'])=1">   
   8) Chu fakindiko GEOL che kapvorto "testo" enestas</t>
 
     <t test="count(//mlg-oj/v[@mrk='test.0o' and
     t='T' and k='testo'])=1">   
   9) Chu mallongigo T che kapvorto "testo" enestas</t>
 
     <t test="count(//bld-oj/v[@mrk='test.0o' and
     t='bildigita testo :-)' and k='testo'])=1">   
   10) Chu bildo pri kapvorto "testo" enestas</t>

     <t test="count(//kap-oj/litero[@name='t']/v[@mrk='test' and k='testoo'])=1">
   11) Chu variajho "testoo" estas sub litero "t"</t>

     <t test="count(//kap-oj/litero[@name='t']/v[@mrk='test.0i' and k='testoi'])=1">
   12) Chu variajho "testoi" estas sub litero "t"</t>

     <t test="count(//trd-oj[@lng='de']/litero[@name='t']/v[@mrk='test.0o.GEOL' and
     k='testo' and t='Test' and t1/u='Test' and t1/text()=' in Definition'])=1">
   13) Chu endifina germana traduko "_Test_ in Definition" estas sub
   litero "t"</t>

     <t test="count(//trd-oj[@lng='de']/litero[@name='t']/v[@mrk='test.0o' and
     k='bildigita testo' and t='Test' and t1/u='Test' and
   contains(t1,'bild')])=1">
   14) Chu germana traduko "Testbild" estas sub litero "t"</t>


</testoj>
]]>
    </echo>

    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-ord"/>
       <param name="testajho" value="${tmp}/inx_ord.xml"/>
    </antcall>

    <loadfile property="rezulto_2" srcFile="${testoj}/indeks-testo-ord.rez"/>
    <echo>test-rezultoj pri dosiero inx_ord.xml:
${rezulto_2}   
    </echo>

    <!-- testu kreadon de la HTML-indeksdosieroj -->

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="html" inheritAll="false"/>

    <echo 
file="${testoj}/indeks-testo-kap-t.xml"><![CDATA[<?xml version="1.0"?>
<testoj>
     <t test="count(//head/title[.='esperanta indekso'])=1">
   1) Chu titolo en kapo estas "esperanta indekso"</t>
     <t test="count(//head/link[@rel='stylesheet' and @href='../stl/indeksoj.css'])=1">
   2) Chu stilfolio estas referencita</t>
     <t test="count(//td[@class='aktiva']/a[@href='../inx/_eo.html'])=1">
   3) Chu aktiva menuero estas Esperanto</t>
     <t test="count(//b[@class='elektita' and .='t'])=1">
   4) Chu aktiva litero estas "t"</t>
     <t test="count(//h1[.='esperanta t...'])=1">
   5) Chu videbla titolo estas "esperanta t..."</t>
     <t test="count(//a[@href='../art/test.html' and @target='precipa'
     and .='testo'])=1">
   6) Chu referenco al test.html enestas</t>
     <t test="count(//a[@href='../art/test.html#test.0i' and @target='precipa'
     and .='testi'])=1">
   7) Chu referenco al test.html#test.0i enestas</t>
     <t test="count(//a[@href='../art/test.html' and @target='precipa'
     and .='testoo'])=1">
   8) Chu referenco al test.html variajho "testoo" enestas</t>
     <t test="count(//a[@href='../art/test.html#test.0i' and @target='precipa'
     and .='testoi'])=1">
   9) Chu referenco al test.html#test.0i variajho "testoi" enestas</t>

</testoj>
]]>
    </echo>

    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-kap-t"/>
       <param name="testajho" value="${inx}/kap_t.html"/>
    </antcall>

    <loadfile property="rezulto_3" srcFile="${testoj}/indeks-testo-kap-t.rez"/>
    <echo>test-rezultoj pri dosiero kap_t.html:
${rezulto_3}   
    </echo>

   <echo 
file="${testoj}/indeks-testo-trd-de.xml"><![CDATA[<?xml version="1.0"?>
<testoj>
     <t test="count(//head/title[.='germana indekso'])=1">
   1) Chu titolo en kapo estas "germana indekso"</t>
     <t test="count(//head/link[@rel='stylesheet' and @href='../stl/indeksoj.css'])=1">
   2) Chu stilfolio estas referencita</t>
     <t test="count(//td[@class='aktiva']/a[@href='../inx/_lng.html'])=1">
   3) Chu aktiva menuero estas Lingvoj</t>
     <t test="count(//b[@class='elektita' and .='t'])=1">
   4) Chu aktiva litero estas "t"</t>
     <t test="count(//h1[.='germana t...'])=1">
   5) Chu videbla titolo estas "germana t..."</t>
     <t test="count(//a[(@href='../art/test.html#test.0o.GEOL' or
     @href='../art/test.html') and @target='precipa'
     and .='testo'])=2">
   6) Chu referenco al test.html au test.html#test.0o.GEOL enestas</t>
     <t test="count(//a[@href='../art/test.html#test.0i' and @target='precipa'
     and .='testi'])=1">
   7) Chu referenco al test.html#test.0i enestas</t>
     <t test="count(//a[@href='../art/test.html#test.0o.GEOL' 
     and .='testo malbona chio malbona'])=1">
   8) Chu ekzemplo traduko "testo malbona chio malbona" enestas</t>
    <t test="count(//a[@href='../art/test.html#test.0o.GEOL' and
   .='...malbona testo...'])=1  and count(//u[.='Test'])=3">
   9) Chu "...schlechter Test...: ...malbona testo..." enestas</t>
     <t test="count(//td[contains(.,'in Definition:')])=1">
   10) Chu "in Definition" enestas</t>
   <t test="count(//a[@href='../art/test.html#test.0o' and
   .='bildigita testo'])=1  and count(//u[.='Test'])=3">
   11) Chu "Testbild" enestas</t>

</testoj>
]]>
    </echo>

    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-trd-de"/>
       <param name="testajho" value="${inx}/lx_de_t.html"/>
    </antcall>

    <loadfile property="rezulto_4" srcFile="${testoj}/indeks-testo-trd-de.rez"/>
    <echo>test-rezultoj pri dosiero lx_de_t.html:
${rezulto_4}   
    </echo>

   <echo 
file="${testoj}/indeks-testo-trd-de2.xml"><![CDATA[<?xml version="1.0"?>
<testoj>

     <t test="count(//b[@class='elektita' and .='k'])=1">
   1) Chu aktiva litero estas "k"</t>
     <t test="count(//h1[.='germana k...'])=1">
   2) Chu videbla titolo estas "germana k..."</t>
     <t test="count(//a[@href='../art/test.html#test.0i'])=3">
   3) Chu 3 referencoj al test.0i enestas</t>

    <t test="count(//td[contains(.,'klrtest1:')])=1">
   4) Chu "klrtest1:" sen indeksa klarigo enestas</t>
     <t test="count(//td[contains(.,'klrtest2 (en la indekso):')])=1">
   5) Chu klrtest2 kun indeksa klarigo enestas</t>
     <t test="count(//td[contains(.,'klrtest3 (en la indekso kaj la artikolo):')])=1">
   6) Chu klrtest3 kun indeksa klarigo enestas</t>

</testoj>
]]>
    </echo>
    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-trd-de2"/>
       <param name="testajho" value="${inx}/lx_de_k.html"/>
    </antcall>

    <loadfile property="rezulto_5" srcFile="${testoj}/indeks-testo-trd-de2.rez"/>
    <echo>test-rezultoj pri dosiero lx_de_k.html:
${rezulto_5}   
    </echo>

   <echo 
file="${testoj}/indeks-testo-trd-de3.xml"><![CDATA[<?xml version="1.0"?>
<testoj>

     <t test="count(//b[@class='elektita' and .='p'])=1">
   1) Chu aktiva litero estas "p"</t>
     <t test="count(//h1[.='germana p...'])=1">
   2) Chu videbla titolo estas "germana p..."</t>
     <t test="count(//a[@href='../art/test.html#test.0i'])=2">
   3) Chu 2 referencoj al test.0i enestas</t>
      <t test="count(//td[contains(.,'aus')])=1 and count(//td/u[.='probieren'])=1">
   4) Chu 'aus' kaj '_probieren_' enestas</t>
      <t test="count(//td[contains(.,'probieren:')])=1">
   5) Chu 'probieren:' enestas</t>

</testoj>
]]>
    </echo>
    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-trd-de3"/>
       <param name="testajho" value="${inx}/lx_de_p.html"/>
    </antcall>

    <loadfile property="rezulto_6" srcFile="${testoj}/indeks-testo-trd-de3.rez"/>
    <echo>test-rezultoj pri dosiero lx_de_p.html:
${rezulto_6}   
    </echo>


    <echo>---------------------------------------------------------------
      *** REZULTOJ DE LA INDEKS-TESTOJ ***</echo>
    <echo>dosiero inx_kat.xml:
${rezulto_1}   
    </echo>
    <echo>dosiero inx_ord.xml:

${rezulto_2}   
    </echo>
    <echo>dosiero kap_t.html:
${rezulto_3}   
    </echo>
    <echo>dosiero lx_de_t.html:
${rezulto_4}   
    </echo>
    <echo>dosiero lx_de_k.html:
${rezulto_5}   
    </echo>
    <echo>dosiero lx_de_p.html:
${rezulto_6}   
    </echo>
  </target>

</project>











