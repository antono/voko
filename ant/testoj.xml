<project name="Revo-testoj" basedir="/home/revo/voko/tst">
    <description>
       Reta Vortaro, testoj.
    </description>

  <!-- set global properties for this build -->
  <property name="voko" location="/home/revo/voko"/>
  <property name="ant" location="${voko}/ant"/>
  <property name="revo" location=".test"/>
  <property name="testoj" location="${revo}/testoj"/>
  <property name="inx" location="${revo}/inx"/>
  <property name="xml" location="${revo}/xml"/>
  <property name="xsl" location="${voko}/xsl"/>
  <property name="tmp" location="${revo}/.tmp"/>

  <target name="init">

   <!-- kreu vortareton por testo -->
   <!-- ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="forigu" inheritAll="false"/ -->

    <mkdir dir="${revo}" />
    <mkdir dir="${xml}" />
 
    <echo 
file="${xml}/test.xml"><![CDATA[<?xml version="1.0"?>
<vortaro>
<art mrk="\$$Id: test.xml asdfosdf">
  <kap><rad>test</rad>/o</kap>
  <drv mrk="test.0o">
    <kap><tld/>o</kap>
    <mlg>T</mlg>
    <snc mrk="test.0o.GEOL">
      <uzo tip="fak">GEOL</uzo>
      <dif>fusx fusx fusx</dif>
      <trd lng="de">Test <klr>(GEO)</klr></trd>
    </snc>
    <snc mrk="test.0o.XXX">
      <dif>balbut balbut balbut</dif>
    </snc>
    <bld src="test.jpg">bildigita testo :-)</bld>
    <trd lng="de">Test</trd>
    <trd lng="en">test</trd>
  </drv>
  <drv mrk="test.0i">
    <kap><tld/>i</kap>
    <dif>strang strang strang</dif>
    <trdgrp lng="de">
      <trd>testen</trd>,
      <trd>probieren</trd>
    </trdgrp>
    <trd lng="en">to test</trd>
  </drv>
</art>
</vortaro>
]]>
    </echo>

    <echo 
file="${xml}/de.xml"><![CDATA[<?xml version="1.0"?>
<vortaro>
<art mrk="\$Id: de.xml asdfosdf">
  <kap><rad>de</rad></kap>
  <drv mrk="de.0">
    <kap><tld/></kap>
    <trdgrp lng="de">
      <trd>Aorta</trd>
      <trd>Apfel</trd>
      <trd>apfel</trd>
      <trd>&#x00c4;pfel</trd>
      <trd>&#x00e4;pfel</trd>
      <trd>Arie</trd>
      <trd>Muse</trd>
      <trd>Mu&#x00df;e</trd>
      <trd>Mut</trd>
    </trdgrp>
    <trdgrp lng="br">
      <trd>cab</trd>
      <trd>chb</trd>
      <trd>c'hb</trd>
    </trdgrp>
    <trdgrp lng="cy">
      <trd>cab</trd>
      <trd>chb</trd>
      <trd>ala</trd>
      <trd>alla</trd>
      <trd>alma</trd>
    </trdgrp>
  </drv>
</art>
</vortaro>
]]>
    </echo>
</target>


<target name="test-init" depends="init"
  description="preparas la testilojn">

    <mkdir dir="${testoj}" />

    <echo 
file="${testoj}/testshablono.tmp"><![CDATA[<?xml version="1.0"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                 version="1.0">

   <xsl:output method="text" encoding="utf-8"/>

   <xsl:template match="/">
   @tests@
   </xsl:template>

   <xsl:template name="testo">
         <xsl:param name="priskribo"/>
         <xsl:param name="testo"/>
    
         <xsl:value-of select="normalize-space($priskribo)"/><xsl:text>: </xsl:text>
         <xsl:choose>
           <xsl:when test="$testo"><xsl:text>bone
</xsl:text></xsl:when>
           <xsl:otherwise><xsl:text>ERARO!
</xsl:text></xsl:otherwise>
         </xsl:choose>

   </xsl:template>
</xsl:stylesheet>
]]>
   </echo>

   <echo 
file="${testoj}/preparu-teston.xsl"><![CDATA[<?xml version="1.0"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                 version="1.0">

   <xsl:output method="text" encoding="utf-8"/>

   <xsl:template match="//t">
     &lt;xsl:call-template name="testo"&gt;
       &lt;xsl:with-param name="priskribo"&gt;
        &lt;xsl:text&gt;<xsl:value-of select="."/>&lt;/xsl:text&gt;
      &lt;/xsl:with-param&gt;
      &lt;xsl:with-param name="testo"&gt;
        &lt;xsl:value-of select="<xsl:value-of select="@test"/>"/&gt;
      &lt;/xsl:with-param&gt;
    &lt;/xsl:call-template&gt;
  </xsl:template> 

</xsl:stylesheet>
]]>
    </echo>
</target>

  <target name="faru-teston">
    <xslt style="${testoj}/preparu-teston.xsl"
        in="${testoj}/${testnomo}.xml" out="${testoj}/${testnomo}.tst"/>

    <loadfile srcFile="${testoj}/${testnomo}.tst" property="tests"/>
    <filter token="tests" value="${tests}"/>
    <copy file="${testoj}/testshablono.tmp" tofile="${testoj}/${testnomo}.xsl" 
       filtering="true"/>

    <xslt style="${testoj}/${testnomo}.xsl"
        in="${testajho}" out="${testoj}/${testnomo}.rez"/>
  </target>



  <target name="indeks-testo" depends="init,test-init"
    description="testas la regulojn en indekso.xml">

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="eltiro" inheritAll="false"/>

      <!-- testu la dosieron indekso.xml -->
      <available file="${tmp}/indekso.xml" property="indekso.xml"/>

      <echo>dosiero indekso.xml ekzistas? ${indekso.xml}</echo>

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="kategorioj" inheritAll="false"/>   

    <echo 
file="${testoj}/indeks-testo.xml"><![CDATA[<?xml version="1.0"?>
<testoj>
     <t test="count(//kap-oj/v[@mrk='test' and k='test/o' and r='tset'])=1">
   1) Chu kapvorto "test/o", inversigita radiko "tset", mrk "test" enestas</t>

     <t test="count(//kap-oj/v[@mrk='test.0o'])=0">
   2) Chu kapvorto kun mrk "test.0o" ne enestas</t>

     <t test="count(//kap-oj/v[@mrk='test.0i' and k='testi'])=1">
   3) Chu kapvorto "testi" mrk "test.0i" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0o' and
     k='testo' and t='Test'])=1">
   4) Chu germana traduko "Test" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='testen'])=1">
   5) Chu germana traduko "testen" enestas</t>

     <t test="count(//trd-oj[@lng='de']/v[@mrk='test.0i' and
     k='testi' and t='probieren'])=1">
   6) Chu germana traduko "probieren" enestas</t>

     <t test="count(//trd-oj[@lng='en']/v[@mrk='test.0i' and
     k='testi' and t='to test'])=1">
   7) Chu angla traduko "to test" enestas</t>

     <t test="count(//fako[@fak='GEOL']/v[@mrk='test.0o.GEOL' and
     .='testo'])=1">   
   8) Chu fakindiko GEOL che kapvorto "testo" enestas</t>
 
     <t test="count(//mlg-oj/v[@mrk='test.0o' and
     t='T' and k='testo'])=1">   
   9) Chu mallongigo T che kapvorto "testo" enestas</t>
 
     <t test="count(//bld-oj/v[@mrk='test.0o' and
     t='bildigita testo :-)' and k='testo'])=1">   
   10) Chu bildo pri kapvorto "testo" enestas</t>
 
</testoj>
]]>
    </echo>

    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo"/>
       <param name="testajho" value="${tmp}/inx_kat.xml"/>
    </antcall>

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="ordigo" inheritAll="false"/>

    <ant antfile="${ant}/indeksoj.xml"
       dir="${revo}" target="html" inheritAll="false"/>

    <echo 
file="${testoj}/indeks-testo-kap-t.xml"><![CDATA[<?xml version="1.0"?>
<testoj>
     <t test="count(//head/title[.='esperanta indekso'])=1">
   1) Chu titolo en kapo estas "esperanta indekso"</t>
     <t test="count(//head/link[@rel='stylesheet' and @href='../stl/indeksoj.css'])=1">
   2) Chu stilfolio estas referencita</t>
     <t test="count(//td[@class='aktiva']/a[@href='../inx/_eo.html'])=1">
   3) Chu aktiva menuero estas Esperanto</t>
     <t test="count(//b[@class='elektita' and .='t'])=1">
   4) Chu aktiva litero estas "t"</t>
     <t test="count(//h1[.='esperanta t...'])=1">
   5) Chu videbla titolo estas "esperanta t..."</t>
     <t test="count(//a[@href='../art/test.html' and @target='precipa'
     and .='testo'])=1">
   6) Chu referenco al test.html enestas</t>
     <t test="count(//a[@href='../art/test.html#test.0i' and @target='precipa'
     and .='testi'])=1">
   7) Chu referenco al test.html#test.0i enestas</t>
</testoj>
]]>
    </echo>

    <antcall target="faru-teston">
       <param name="testnomo" value="indeks-testo-kap-t"/>
       <param name="testajho" value="${inx}/kap_t.html"/>
    </antcall>


    <loadfile property="rezulto_1" srcFile="${testoj}/indeks-testo.rez"/>
    <echo>REZULTOJ DE LA INDEKS-TESTO</echo>
    <echo>dosiero inx_kat.xml:
${rezulto_1}   
    </echo>
    <loadfile property="rezulto_2" srcFile="${testoj}/indeks-testo-kap-t.rez"/>
    <echo>dosiero kap_t.html:
${rezulto_2}   
    </echo>

  </target>

</project>











